import { Callout } from 'nextra/components'

# Migration · v8 → v9

Version 9 introduces a new configuration layout for the entire toolchain. The `patch`/`mangle` blocks have been replaced by a clearer `registry`/`transformer` split, and both `tailwindcss-patch` and `unplugin-tailwindcss-mangle` read the same structure. This guide walks you through updating existing projects.

<Callout type="info">
Legacy configs keep working. `@tailwindcss-mangle/config` converts older shapes on load, so you can migrate file by file when convenient.
</Callout>

## 1. Update dependencies

```sh npm2yarn
npm i -D tailwindcss-patch@^9 unplugin-tailwindcss-mangle@latest @tailwindcss-mangle/config@latest @tailwindcss-mangle/core@latest
```

- `tailwindcss-patch` v9 exports the registry APIs and understands the new config layout.
- `unplugin-tailwindcss-mangle` consumes the shared transformer options.
- `@tailwindcss-mangle/config` performs the legacy → modern conversion automatically.

## 2. Rename the config blocks

| Legacy | New name | Notes |
| --- | --- | --- |
| `patch` | `registry` | Everything related to extraction, Tailwind integration, cache, and feature flags. |
| `patch.output` | `registry.output` | `filename` → `file`, `removeUniversalSelector` → `stripUniversalSelector`. |
| `patch.tailwindcss` | `registry.tailwind` | `v4` becomes `next`, `v3` → `classic`, `v2` → `legacy`. |
| `patch.applyPatches` | `registry.features` | `exportContext` and `extendLengthUnits` move here. |
| `cache` / `overwrite` | `registry.cache` / `registry.overwrite` | Cache options now live under the registry block. |
| `mangle` | `transformer` | Controls inclusion patterns, generators, registry mapping, and preservation rules. |
| `mangle.classListPath` | `transformer.registry.file` | The class list path moves under the `registry` sub-object. |
| `mangle.classMapOutput` | `transformer.registry.mapping` | Keep the same options; set to `true` to reuse defaults. |
| `mangle.preserveFunction` | `transformer.preserve.functions` | Accepts an array of helper names. |

### Before

```ts
export default defineConfig({
  patch: {
    output: {
      filename: '.tw-patch/tw-class-list.json',
      removeUniversalSelector: true,
    },
    tailwindcss: {
      version: 4,
      v4: {
        cssEntries: ['dist/tailwind.css'],
      },
    },
  },
  mangle: {
    classListPath: '.tw-patch/tw-class-list.json',
    classMapOutput: {
      enable: true,
      filename: '.tw-patch/tw-map-list.json',
    },
    preserveFunction: ['twIgnore'],
  },
})
```

### After

```ts
export default defineConfig({
  registry: {
    output: {
      file: '.tw-patch/tw-class-list.json',
      stripUniversalSelector: true,
    },
    tailwind: {
      version: 4,
      next: {
        cssEntries: ['dist/tailwind.css'],
      },
    },
  },
  transformer: {
    registry: {
      file: '.tw-patch/tw-class-list.json',
      mapping: {
        enabled: true,
        file: '.tw-patch/tw-map-list.json',
      },
    },
    preserve: {
      functions: ['twIgnore'],
    },
  },
})
```

## 3. CLI behaviour

`tw-patch install` and `tw-patch extract` automatically read the new structure. No flags change in v9, and the CLI still respects `--output`, `--format`, `--css`, and `--no-write`. If you rely on JSON editing in pipelines, adjust any scripts that wrote to `patch.output.filename` to look at `registry.output.file` instead.

## 4. Bundler plugin alignment

`unplugin-tailwindcss-mangle` now mirrors the `transformer` section exactly. You can drop most inline options and reuse the shared config:

```ts
import tailwindcssMangle from 'unplugin-tailwindcss-mangle/vite'
import config from './tailwindcss-patch.config'

export default defineConfig({
  plugins: [
    tailwindcssMangle({
      ...config.transformer,
      // override per build if needed
      disabled: process.env.NODE_ENV !== 'production',
    }),
  ],
})
```

When migrating from inline plugin options, map them to the shared config:

| Plugin option | Transformer field |
| --- | --- |
| `classListPath` | `transformer.registry.file` |
| `classMapOutput` | `transformer.registry.mapping` |
| `include` / `exclude` | `transformer.sources.include` / `transformer.sources.exclude` |
| `classGenerator` | `transformer.generator` |
| `preserveFunction` | `transformer.preserve.functions` |

## 5. Upgrade checklist

1. Update packages to the v9 versions.
2. Rename `patch` → `registry`, `mangle` → `transformer`, and adjust nested fields as shown above.
3. Remove any duplicated plugin options in Vite/Webpack configs—reuse `config.transformer` instead.
4. Rerun `tw-patch extract` to refresh `.tw-patch/tw-class-list.json` after the rename.
5. Trigger a production build with `unplugin-tailwindcss-mangle` and confirm classes are rewritten as expected.

Once these steps are complete, your project uses the unified configuration layout while remaining compatible with legacy helpers.
