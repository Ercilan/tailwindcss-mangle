import { Callout } from 'nextra/components'

# 3.配置

整套工具现在通过 `@tailwindcss-mangle/config` 提供统一的配置入口。顶层包含两个部分：

- `registry` 负责收集 Tailwind 生成的类名并应用补丁。
- `transformer` 则在应用代码中重写这些类名。

旧版仍然接受 `patch` / `mangle` 结构，加载时会被自动转换；新项目建议直接采用更新后的字段，语义更加清晰。

## 快速生成模板

```sh npm2yarn
npx tw-patch init
```

命令会在项目根目录创建一个最小配置：

```ts
import { defineConfig } from 'tailwindcss-patch'

export default defineConfig({})
```

<Callout type="info">
`defineConfig` 提供完善的类型提示。未知字段会被原样保留，方便直接传递给 `TailwindcssPatcher` 或构建插件。
</Callout>

## 配置示例

```ts
import { defineConfig } from 'tailwindcss-patch'

export default defineConfig({
  registry: {
    output: {
      file: '.tw-patch/tw-class-list.json',
      format: 'json',
      pretty: 2,
      stripUniversalSelector: true,
    },
    tailwind: {
      version: 4,
      next: {
        cssEntries: ['dist/tailwind.css'],
        sources: [
          { base: 'src', pattern: '**/*.{astro,tsx,mdx}', negated: false },
        ],
      },
    },
    features: {
      exportContext: true,
      extendLengthUnits: {
        units: ['rpx'],
      },
    },
    cache: {
      enabled: true,
      dir: '.tw-patch/cache',
      strategy: 'merge',
    },
  },
  transformer: {
    sources: {
      include: [/\.(html|vue|tsx|jsx|mdx)$/],
    },
    generator: {
      classPrefix: 'tw-',
      reserveClassName: [/^theme-/],
    },
    registry: {
      file: '.tw-patch/tw-class-list.json',
      mapping: {
        enabled: false,
        file: '.tw-patch/tw-map-list.json',
        loose: true,
      },
    },
    preserve: {
      functions: ['twIgnore'],
    },
  },
})
```

## Registry 选项

### `output`

- `file` – 类名清单的输出位置（默认 `.tw-patch/tw-class-list.json`）。
- `format` – `json` 或 `lines`，CLI 默认写入 JSON。
- `pretty` – 写入 JSON 时的缩进；可以是 `false`、布尔值或数字。
- `stripUniversalSelector` – 为 `true` 时从清单中移除 `*`。

### `tailwind`

- `version` – 可选提示（`2`/`3`/`4`），在多版本共存时用于快速定位。
- `legacy` / `classic` – 配置 v2/v3 所在包的 `cwd` 与 `config`。
- `next.cssEntries` – Tailwind v4 Oxide 扫描使用的 CSS 入口，可重复声明。
- `next.sources` – v4 的内容源，默认为 `base` 下的 `**/*`。

### `features`

- `exportContext` – 将 Tailwind 运行时上下文导出，便于 API 回读。
- `extendLengthUnits` – 自定义长度单位补丁，支持 `false`、`true` 或配置对象（`units`、`overwrite` 等）。

### `cache`

- `enabled` – 是否缓存已收集的类名（默认启用，目录位于 `node_modules/.cache/tailwindcss-patch`）。
- `dir` / `file` – 缓存文件的目录与名称。
- `strategy` – `merge` 追加至现有集合，`overwrite` 每次重新生成。

## Transformer 选项

该模块同时被核心运行时与 `unplugin-tailwindcss-mangle` 使用。

- `sources.include` / `sources.exclude` – 限定需要扫描的文件，默认覆盖 HTML、常见框架、CSS 与 MDX。
- `generator` – 通过 `classPrefix`、`reserveClassName`、`exclude` 或 `customGenerate` 自定义压缩后的类名。
- `registry.file` – 指向 registry 导出的类名清单。
- `registry.mapping` – `true` 复用默认写盘逻辑；对象形式可开启 JSON 输出（`enabled`、`file`、`loose`）；也可以传入回调自行处理。
- `filter` – 在生成前覆写类名过滤函数。
- `preserve.functions` – 指定 helper 名称（如 `twIgnore`），在模板字符串中保留原始内容。
- `disabled` – 为 `true` 时跳过混淆（默认只在 `NODE_ENV=development` 时禁用）。

<Callout type="info">
旧结构（`patch` / `mangle`）依旧兼容，加载时会自动转换成新的字段，迁移可以循序渐进完成。
</Callout>

## 如何使用

- `tw-patch install` / `tw-patch extract` 会自动读取该文件。
- `unplugin-tailwindcss-mangle` 共享同一份配置，CLI 与插件行为保持一致。
- 如果需要编程式调用，直接实例化 `TailwindcssPatcher` 并传入 `registry` 部分即可；旧字段会在运行时完成归一化。
