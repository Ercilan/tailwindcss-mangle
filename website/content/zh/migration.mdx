import { Callout } from 'nextra/components'

# 迁移 · v8 → v9

9.0 版本重新整理了整套配置。原先的 `patch`/`mangle` 被更直观的 `registry`/`transformer` 所取代，`tailwindcss-patch` 与 `unplugin-tailwindcss-mangle` 读取的是同一份数据。下面是从 v8.x 升级的步骤。

<Callout type="info">
旧版配置仍然有效，`@tailwindcss-mangle/config` 会在加载时自动转换，因此可以按模块逐步迁移。
</Callout>

## 1. 升级依赖

```sh npm2yarn
npm i -D tailwindcss-patch@^9 unplugin-tailwindcss-mangle@latest @tailwindcss-mangle/config@latest @tailwindcss-mangle/core@latest
```

- `tailwindcss-patch` v9 暴露新的 registry API 并识别统一结构。
- `unplugin-tailwindcss-mangle` 使用与 transformer 相同的字段。
- `@tailwindcss-mangle/config` 负责旧字段到新字段的归一化。

## 2. 重命名配置块

| 旧字段 | 新字段 | 说明 |
| --- | --- | --- |
| `patch` | `registry` | 负责提取、Tailwind 集成、缓存与功能开关。 |
| `patch.output` | `registry.output` | `filename` → `file`，`removeUniversalSelector` → `stripUniversalSelector`。 |
| `patch.tailwindcss` | `registry.tailwind` | `v4` 重命名为 `next`，`v3` → `classic`，`v2` → `legacy`。 |
| `patch.applyPatches` | `registry.features` | `exportContext`、`extendLengthUnits` 调整到此处。 |
| `cache` / `overwrite` | `registry.cache` / `registry.overwrite` | 缓存相关配置统一放在 registry 内。 |
| `mangle` | `transformer` | 控制扫描、生成器、映射输出与保留规则。 |
| `mangle.classListPath` | `transformer.registry.file` | 指向提取出的类名清单。 |
| `mangle.classMapOutput` | `transformer.registry.mapping` | 参数一致，`true` 仍表示启用默认写盘。 |
| `mangle.preserveFunction` | `transformer.preserve.functions` | 支持函数名数组。 |

### 迁移前

```ts
export default defineConfig({
  patch: {
    output: {
      filename: '.tw-patch/tw-class-list.json',
      removeUniversalSelector: true,
    },
    tailwindcss: {
      version: 4,
      v4: {
        cssEntries: ['dist/tailwind.css'],
      },
    },
  },
  mangle: {
    classListPath: '.tw-patch/tw-class-list.json',
    classMapOutput: {
      enable: true,
      filename: '.tw-patch/tw-map-list.json',
    },
    preserveFunction: ['twIgnore'],
  },
})
```

### 迁移后

```ts
export default defineConfig({
  registry: {
    output: {
      file: '.tw-patch/tw-class-list.json',
      stripUniversalSelector: true,
    },
    tailwind: {
      version: 4,
      next: {
        cssEntries: ['dist/tailwind.css'],
      },
    },
  },
  transformer: {
    registry: {
      file: '.tw-patch/tw-class-list.json',
      mapping: {
        enabled: true,
        file: '.tw-patch/tw-map-list.json',
      },
    },
    preserve: {
      functions: ['twIgnore'],
    },
  },
})
```

## 3. CLI 行为

`tw-patch install` 与 `tw-patch extract` 会自动读取新结构，参数保持不变。若脚本中读取 `patch.output.filename`，记得改为 `registry.output.file`。

## 4. 构建插件对齐

`unplugin-tailwindcss-mangle` 现在直接使用 `transformer` 配置，可在项目中复用统一字段：

```ts
import tailwindcssMangle from 'unplugin-tailwindcss-mangle/vite'
import config from './tailwindcss-patch.config'

export default defineConfig({
  plugins: [
    tailwindcssMangle({
      ...config.transformer,
      disabled: process.env.NODE_ENV !== 'production',
    }),
  ],
})
```

常见选项映射如下：

| 插件字段 | 新配置 |
| --- | --- |
| `classListPath` | `transformer.registry.file` |
| `classMapOutput` | `transformer.registry.mapping` |
| `include` / `exclude` | `transformer.sources.include` / `transformer.sources.exclude` |
| `classGenerator` | `transformer.generator` |
| `preserveFunction` | `transformer.preserve.functions` |

## 5. 升级检查清单

1. 安装最新依赖（`tailwindcss-patch@^9` 等）。
2. 将配置重命名为 `registry` / `transformer`，并调整字段名。
3. 检查构建脚本，复用 `config.transformer`，避免重复声明插件选项。
4. 重新执行 `tw-patch extract` 生成 `.tw-patch/tw-class-list.json`。
5. 运行一次生产构建，确认类名已经按照预期重写。

完成上述步骤后，你的项目已经使用统一的配置结构，同时仍兼容旧版工具。
