import { Callout } from 'nextra/components'

# 1. Patch

`tailwindcss-patch` 是整个混淆流程的第一步。8.0 版本重构了架构，帮助你捕获运行时上下文、枚举 Tailwind CSS 可以生成的所有类名，并让这些数据与现代项目保持同步。

## 8.0 版本速览

- 模块重新分层（`api/`、`patching/`、`runtime/`、`extraction/`、`cache/`），提供清晰且类型化的导入入口。
- 统一的配置对象自动兼容旧版 `patch`/`cache` 结构，同时集中管理缓存、输出与功能开关。
- 对 Tailwind CSS v4 提供一等支持，可直接扫描 CSS 产物与项目内容源，与 v2/v3 的运行时补丁并行工作。
- 全新的 CLI 日志体验，并为 `extract` 命令带来 `--output`、`--format`、`--css`、`--no-write` 等新选项。

<Callout type="info">
需要从 7.x 升级？查看 <a href="https://github.com/icebreaker/tailwindcss-mangle/blob/main/packages/tailwindcss-patch/MIGRATION.md" target="_blank" rel="noreferrer">迁移指南</a> 获取逐步检查清单。
</Callout>

## 安装

请确认运行环境使用 Node.js 18 或更新版本。

### 安装依赖

```sh npm2yarn
npm i -D tailwindcss-patch
```

### 为 Tailwind 打补丁

```sh npm2yarn
npx tw-patch install
```

### 安装后保持补丁有效

`package.json`

```json
{
  "scripts": {
    "prepare": "tw-patch install"
  }
}
```

## CLI 工作流

通过 `tw-patch` 运行 CLI，建议在包含 `tailwind.config.*` 的项目根目录执行：

```sh
npx tw-patch install
npx tw-patch extract
```

默认情况下 `extract` 会写入 `.tw-patch/tw-class-list.json`。可以使用以下参数调整生成文件或输出格式：

| 参数 | 说明 |
| --- | --- |
| `--cwd <dir>` | 从指定目录解析配置。 |
| `--output <file>` | 覆盖 `extract` 写入的目标文件。 |
| `--format <json|lines>` | 选择 JSON（默认）或按行输出文本。 |
| `--css <file>` | 为 Tailwind v4 提供 CSS 入口文件；可重复使用多个参数。 |
| `--no-write` | 跳过写入磁盘，仅在调用者中返回类名列表。 |

CLI 会通过 `@tailwindcss-mangle/config` 读取 `tailwindcss-patch.config.ts`（兼容旧的 `tailwindcss-mangle.config.ts`），因此现有配置仍然可用。

## 配置

若尚未创建配置文件，可以先初始化：

```sh npm2yarn
npx tw-patch init
```

`tailwindcss-patch.config.ts`

```ts
import { defineConfig } from 'tailwindcss-patch'

export default defineConfig({
  patch: {
    output: {
      filename: '.tw-patch/tw-class-list.json',
      format: 'json',
      pretty: 2,
      removeUniversalSelector: true,
    },
    tailwindcss: {
      version: 4,
      v4: {
        cssEntries: ['dist/tailwind.css'],
        sources: [
          { base: 'src', pattern: '**/*.{html,tsx}', negated: false },
        ],
      },
    },
    applyPatches: {
      exportContext: true,
      extendLengthUnits: {
        units: ['rpx'],
      },
    },
  },
})
```

虽然 `defineConfig` 仍然返回旧版结构（`patch`、`applyPatches`、`tailwindcss`），但 8.0 新字段已经全部支持。你可以按需逐步迁移，运行时会自动标准化配置。

## 编程接口

新版构造函数接受统一的配置对象，带有 `patch`/`cache` 字段的旧结构也会在内部转换：

```ts
import { TailwindcssPatcher } from 'tailwindcss-patch'

const patcher = new TailwindcssPatcher({
  overwrite: true,
  cache: {
    enabled: true,
    dir: '.tw-patch/cache',
    strategy: 'merge',
  },
  output: {
    file: '.tw-patch/tw-class-list.json',
    format: 'json',
    pretty: 2,
  },
  features: {
    exposeContext: { refProperty: 'runtimeContexts' },
    extendLengthUnits: { units: ['rpx'] },
  },
  tailwind: {
    version: 4,
    v4: {
      base: './src',
      cssEntries: ['dist/tailwind.css'],
    },
  },
})

await patcher.patch()
const { classList, filename } = await patcher.extract()
const contexts = patcher.getContexts()
const classSet = await patcher.getClassSet()
```

### 实用工具

还可以直接使用以下导出的工具来构建自定义工作流：

- `CacheStore` —— 管理类名缓存，可选择合并或覆盖策略。
- `normalizeOptions` —— 将用户输入转换成运行时使用的标准结构。
- `extractValidCandidates` —— 基于 Tailwind Oxide 的 v4 候选提取器。
- `runTailwindBuild` —— 启动 Tailwind v2/v3 编译以收集运行时上下文。

## 升级检查清单

1. 安装 `tailwindcss-patch@^8.0.0` 并执行 `tw-patch install`。
2. 检查自定义的 `tailwindcss-patch/core/*` 导入，替换为新的公开模块路径。
3. 根据需要更新脚本中的 CLI 参数。
4. 如果是 Tailwind v4 项目，请配置 `cssEntries` 与 `sources`。
5. 运行 `tw-patch extract` 重新生成 `.tw-patch/tw-class-list.json`，确认输出后再继续执行混淆流程。
